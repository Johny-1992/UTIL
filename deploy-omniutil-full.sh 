#!/bin/bash
set -e

echo "ğŸŒŸ DÃ©but du dÃ©ploiement complet OmniUtil"

FRONTEND_DIR="./frontend"
BACKEND_URL="https://omniutil.onrender.com"
ALIAS_DOMAIN="omniutil.vercel.app"

# 1ï¸âƒ£ Nettoyage
echo "ğŸ§¹ Nettoyage des anciens builds et modules..."
rm -rf $FRONTEND_DIR/build $FRONTEND_DIR/node_modules $FRONTEND_DIR/.vercel

# 2ï¸âƒ£ Installation des dÃ©pendances frontend
echo "ğŸ“¦ Installation des dÃ©pendances frontend..."
cd $FRONTEND_DIR
npm install

# 3ï¸âƒ£ PrÃ©parer les fichiers publics
mkdir -p public
if [ -f ../sitemap.xml ]; then
    cp ../sitemap.xml public/sitemap.xml
fi
if [ -f ../google05be3ba8343d04a2.html ]; then
    cp ../google05be3ba8343d04a2.html public/google05be3ba8343d04a2.html
fi

# 4ï¸âƒ£ Build frontend
echo "ğŸš€ Build frontend..."
npm run build

# 5ï¸âƒ£ DÃ©ploiement frontend sur Vercel
echo "ğŸŒ DÃ©ploiement frontend sur Vercel..."
vercel --prod --yes
vercel alias set $(vercel list | grep "Production" | awk '{print $2}') $ALIAS_DOMAIN

# 6ï¸âƒ£ VÃ©rifications post-dÃ©ploiement
echo "ğŸ” VÃ©rifications des fichiers essentiels..."
[ -f public/sitemap.xml ] && echo "âœ… sitemap.xml prÃ©sent" || echo "âš ï¸ sitemap.xml manquant"
[ -f public/google05be3ba8343d04a2.html ] && echo "âœ… Google verification prÃ©sent" || echo "âš ï¸ Google verification manquant"
[ -d ./build ] && echo "âœ… Build frontend prÃ©sent" || echo "âš ï¸ Build frontend manquant"
echo "âœ… Backend accessible Ã  : $BACKEND_URL"

echo "ğŸ¯ DÃ©ploiement complet terminÃ© !"
echo "ğŸŒ Site disponible sur : https://$ALIAS_DOMAIN"
