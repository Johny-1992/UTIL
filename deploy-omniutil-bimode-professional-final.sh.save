#!/bin/bash
set -e

echo "=========================================="
echo "üöÄ OMNIUTIL ‚Äì BIMODE PROFESSIONNEL FINAL"
echo "=========================================="

ROOT_DIR=$(pwd)

# --------------------------------------------------
# 1Ô∏è‚É£ Chargement .env (OBLIGATOIRE)
# --------------------------------------------------
if [ ! -f ".env" ]; then
  echo "‚ùå .env introuvable ‚Äì arr√™t"
  exit 1
fi

set -a
source .env
set +a

echo "‚úÖ .env charg√©"
echo "üîß MODE ACTUEL : $MODE"

# --------------------------------------------------
# 2Ô∏è‚É£ V√©rification structure projet
# --------------------------------------------------
REQUIRED_DIRS=("frontend" "backend" "contracts" "scripts")
for dir in "${REQUIRED_DIRS[@]}"; do
  if [ ! -d "$dir" ]; then
    echo "‚ùå Dossier manquant: $dir"
    exit 1
  fi
done

mkdir -p versions/{frontend,backend,contracts,cpp}
mkdir -p logs

echo "‚úÖ Structure projet OK"

# --------------------------------------------------
# 3Ô∏è‚É£ FRONTEND ‚Äì deps + build
# --------------------------------------------------
cd frontend

echo "üì¶ Frontend deps"
npm install

echo "üèóÔ∏è Build frontend"
npm run build

cd "$ROOT_DIR"

# --------------------------------------------------
# 4Ô∏è‚É£ SEO / PUBLIC (cr√©ation uniquement si manquant)
# --------------------------------------------------
PUBLIC_DIR="frontend/public"
mkdir -p "$PUBLIC_DIR"

[ ! -f "$PUBLIC_DIR/robots.txt" ] && echo -e "User-agent: *\nAllow: /" > "$PUBLIC_DIR/robots.txt"
[ ! -f "$PUBLIC_DIR/sitemap.xml" ] && echo "<urlset></urlset>" > "$PUBLIC_DIR/sitemap.xml"
[ ! -f "$PUBLIC_DIR/google05be3ba8343d04a2.html" ] && echo "google-site-verification" > "$PUBLIC_DIR/google05be3ba8343d04a2.html"

echo "‚úÖ SEO / public v√©rifi√©"

# --------------------------------------------------
# 5Ô∏è‚É£ BACKEND ‚Äì deps uniquement
# --------------------------------------------------
cd backend
echo "üîó Backend"
npm install
cd "$ROOT_DIR"

# --------------------------------------------------
# 6Ô∏è‚É£ SMART CONTRACT ‚Äì EXISTANT UNIQUEMENT
# --------------------------------------------------
echo "üìÑ Smart Contract"

CONTRACT_PATH="contracts/core/OmniUtilCore.sol"
OUTPUT_DIR="versions/contracts"

if [ -f "$CONTRACT_PATH" ]; then
  echo "Contrat trouv√©: $CONTRACT_PATH"
  mkdir -p "$OUTPUT_DIR"

  echo "üìÑ Compilation du cont# --------------------------------------------------
# 7Ô∏è‚É£ C++ ORCHESTRATEUR ‚Äì auto Makefile si absent
# --------------------------------------------------
if [ -d "cpp" ]; then
  cd cpp
  if [ ! -f "Makefile" ]; then
    echo "‚öôÔ∏è Cr√©ation Makefile C++ minimal"
    cat <<EOF > Makefile
all:
\tg++ -std=c++17 -O2 *.cpp -o orchestrator || true
EOF
  fi

  make || echo "‚ö†Ô∏è Compilation C++ ignor√©e"
  cd "$ROOT_DIR"
else
  echo "‚ÑπÔ∏è Dossier cpp absent ‚Äì orchestration ignor√©e"
fi

# --------------------------------------------------
# 8Ô∏è‚É£ BIMODE LOGIC (DEMO / LIVE)
# --------------------------------------------------
echo "üß† BIMODE LOGIC"

if [ "$MODE" = "DEMO" ]; then
  echo "üîµ Mode DEMO actif"
elif [ "$MODE" = "LIVE" ]; then
  echo "üü¢ Mode LIVE actif"
else
  echo "‚ö†Ô∏è MODE inconnu ‚Äì fallback DEMO"
fi

# --------------------------------------------------
# 9Ô∏è‚É£ SNAPSHOT VERSION
# --------------------------------------------------
VERSION="v1.0.0"
echo "üì¶ Snapshot version $VERSION"
tar czf "versions/frontend/frontend-$VERSION.tar.gz" frontend/build || true

# --------------------------------------------------
# üîü DEPLOIEMENT VERCEL
# --------------------------------------------------
echo "üåç D√©ploiement frontend sur Vercel"

cd frontend
vercel --prod --yes
cd "$ROOT_DIR"

echo "=========================================="
echo "üéâ OMNIUTIL ‚Äì BIMODE PROFESSIONNEL OP√âRATIONNEL"
echo "üåê MODE : $MODE"
echo "=========================================="
