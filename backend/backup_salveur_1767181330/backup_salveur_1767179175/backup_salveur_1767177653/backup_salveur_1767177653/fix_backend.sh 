#!/bin/bash
# Script : fix_backend.sh
# But : Recompiler le backend et corriger les exports pour que les endpoints fonctionnent

echo "ğŸ“¦ Nettoyage et reconstruction du backend"

# Supprime l'ancien dist
rm -rf dist

# Installe les dÃ©pendances et compile TypeScript
echo "ğŸ”¹ Installation des dÃ©pendances..."
npm install

echo "ğŸ”¹ Compilation TypeScript..."
npx tsc

# VÃ©rifie si index.js existe
if [ ! -f dist/index.js ]; then
    echo "âŒ dist/index.js manquant aprÃ¨s compilation !"
    exit 1
fi

echo "âœ… dist/index.js prÃ©sent"

# Relance PM2
echo "ğŸ”„ Relance de PM2..."
pm2 delete omniutil-api || true
pm2 start dist/index.js --name omniutil-api --watch
pm2 save

# VÃ©rifie santÃ© API
curl -s http://127.0.0.1:3000/health | grep ok >/dev/null
if [ $? -eq 0 ]; then
    echo "âœ… Backend fonctionnel sur port 3000"
else
    echo "âŒ Backend ne rÃ©pond pas correctement"
fi
