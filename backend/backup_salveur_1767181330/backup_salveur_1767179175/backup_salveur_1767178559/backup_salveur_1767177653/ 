#!/bin/bash
echo "================================================="
echo "ğŸš€ OMNIUTIL â€” STEP 3 SALVATEUR ULTIMATE FINAL"
echo "================================================="

# Chemins
SRC_INDEX="/root/omniutil/backend/src/index.ts"
DIST_DIR="/root/omniutil/backend/dist"
PM2_APP="omniutil-api"

echo "ğŸ“¦ VÃ©rification fichiers essentiels..."
if [[ -f "/root/omniutil/backend/src/api/ai.ts" ]] && [[ -f "/root/omniutil/backend/src/api/partner_validation.ts" ]] && [[ -f "$SRC_INDEX" ]]; then
    echo "âœ… Fichiers essentiels trouvÃ©s."
else
    echo "âŒ Fichiers essentiels manquants. VÃ©rifie le rÃ©pertoire src."
    exit 1
fi

echo "âœï¸ Correction index.ts pour PORT..."
# Remplace la dÃ©claration du PORT
sed -i "s|const PORT.*|const PORT: number = Number(process.env.PORT) || 3000;|" "$SRC_INDEX"

# Suppression dist
echo "ğŸ“¦ Suppression $DIST_DIR..."
rm -rf "$DIST_DIR"

# Installation dÃ©pendances
echo "ğŸ“¦ Installation dÃ©pendances..."
npm install

# Compilation TypeScript
echo "ğŸ“¦ Compilation TypeScript..."
tsc
if [[ $? -ne 0 ]]; then
    echo "âŒ Erreur lors de la compilation TypeScript."
    exit 1
fi
echo "âœ… Compilation terminÃ©e."

# RedÃ©marrage PM2
echo "ğŸ”„ RedÃ©marrage PM2..."
pm2 delete "$PM2_APP" 2>/dev/null
pm2 start "$DIST_DIR/index.js" --name "$PM2_APP"
pm2 save

# VÃ©rification /health
echo "ğŸŒ VÃ©rification endpoint /health..."
for i in {1..10}; do
    STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://127.0.0.1:3000/health)
    if [[ "$STATUS" == "200" ]]; then
        echo "ğŸ‰ /health est disponible ! Server OK."
        exit 0
    else
        echo "âš ï¸ Tentative $i: /health â†’ HTTP $STATUS, redÃ©marrage PM2..."
        pm2 restart "$PM2_APP" --update-env
        sleep 2
    fi
done

echo "âŒ /health toujours non disponible aprÃ¨s 10 tentatives."
exit 1

