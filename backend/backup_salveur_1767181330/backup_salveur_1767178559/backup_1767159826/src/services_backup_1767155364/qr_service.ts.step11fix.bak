import { Request } from 'express';

export interface QrContext {
  partnerId: string;
  userId?: string;
  campaignId?: string;
  extra?: Record<string, unknown>;
}

export function encodeQrContext(ctx: QrContext): string {
  const json = JSON.stringify(ctx);
  return Buffer.from(json, 'utf8').toString('base64');
}

export function decodeQrContext(payload: string): QrContext {
  const json = Buffer.from(payload, 'base64').toString('utf8');
  const parsed = JSON.parse(json);
  if (!parsed.partnerId || typeof parsed.partnerId !== 'string') {
    throw new Error('Invalid QR context: missing partnerId');
  }
  return parsed as QrContext;
}

export function buildQrContextFromRequest(req: Request): QrContext {
  const { partnerId, userId, campaignId, ...rest } = req.body || {};
  if (typeof partnerId !== 'string') {
    throw new Error('partnerId is required to build QR context');
  }
  const ctx: QrContext = { partnerId };
  if (typeof userId === 'string') ctx.userId = userId;
  if (typeof campaignId === 'string') ctx.campaignId = campaignId;
  if (Object.keys(rest).length > 0) ctx.extra = rest as Record<string, unknown>;
  return ctx;
}
