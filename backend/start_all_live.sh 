#!/bin/bash
# ==============================
# OmniUtil â€“ Live Local Dev + Auto Ports
# ==============================

echo "ðŸ”¹ ArrÃªt des serveurs existantsâ€¦"

kill_pid() {
    if [ ! -z "$1" ]; then
        echo "ðŸ’€ Kill PID $1"
        kill -9 $1 2>/dev/null
    fi
}

# Kill backend / frontend si existants
BACKEND_PID=$(pgrep -f "node dist/index.js")
FRONTEND_PID=$(pgrep -f "python3 -m http.server")
kill_pid $BACKEND_PID
kill_pid $FRONTEND_PID

# Fonction pour trouver un port libre Ã  partir d'un port donnÃ©
get_free_port() {
    local port=$1
    while : ; do
        (echo >/dev/tcp/127.0.0.1/$port) &>/dev/null
        if [ $? -ne 0 ]; then
            echo $port
            return
        fi
        port=$((port+1))
    done
}

# Trouver ports libres pour backend et frontend
BACKEND_PORT=$(get_free_port 8080)
FRONTEND_PORT=$(get_free_port $((BACKEND_PORT + 1)))

echo "ðŸ“¦ Compilation TypeScriptâ€¦"
node --max-old-space-size=4096 $(which npx) tsc

# Lancer backend Node.js
echo "ðŸš€ DÃ©marrage backend sur le port $BACKEND_PORTâ€¦"
node dist/index.js --port $BACKEND_PORT > backend.log 2>&1 &
BACKEND_PID=$!

# Lancer frontend statique avec ou sans hot reload
echo "ðŸŒ DÃ©marrage frontend statique sur le port $FRONTEND_PORTâ€¦"

if ! command -v entr &> /dev/null; then
    echo "âš ï¸ 'entr' n'est pas installÃ©, le hot reload ne sera pas actif."
    python3 -m http.server $FRONTEND_PORT > frontend.log 2>&1 &
    FRONTEND_PID=$!
else
    # Hot reload avec entr pour surveiller dist/, src/ et index.html
    find ./dist ./src ./index.html -type f | entr -r python3 -m http.server $FRONTEND_PORT &
    FRONTEND_PID=$!
fi

echo "âœ… Tout est lancÃ© !"
echo "Backend : http://localhost:$BACKEND_PORT"
echo "Frontend : http://localhost:$FRONTEND_PORT/index.html"
echo ""
echo "ðŸ’¡ Pour stopper proprement, faire : kill $BACKEND_PID $FRONTEND_PID"
